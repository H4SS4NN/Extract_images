<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Extraction Validator - V√©rification des Images</title>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons (CDN) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --background-primary: #0f172a;
            --background-secondary: #1e293b;
            --background-tertiary: #334155;
            --surface-primary: #ffffff;
            --surface-secondary: #f8fafc;
            --surface-tertiary: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #94a3b8;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            color: var(--text-primary);
            line-height: 1.6;
            font-weight: 400;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--surface-primary);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light), var(--success-color));
        }

        .header h1 {
            color: var(--text-primary);
            margin: 0 0 24px 0;
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .header h1::before {
            content: 'üîç';
            font-size: 36px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .session-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .info-badge {
            background: var(--surface-secondary);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }

        .info-badge:hover {
            background: var(--surface-tertiary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .session-selector {
            margin-top: 20px;
            padding: 20px;
            background: var(--surface-secondary);
            border-radius: 16px;
            border: 1px solid var(--border-color);
        }

        .session-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .session-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .session-select {
            flex: 1;
            padding: 12px 16px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            background: var(--surface-primary);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .session-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
        }

        .refresh-btn {
            padding: 12px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            background: var(--surface-primary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 48px;
        }

        .refresh-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: var(--surface-primary);
            border-radius: 20px;
            padding: 24px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .panel:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
            position: relative;
        }

        .panel-header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
        }

        .panel-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.01em;
        }

        .pdf-viewer {
            width: 100%;
            height: 100vh; /* plein √©cran pour la page PDF */
            border: 2px solid var(--border-color);
            border-radius: 16px;
            overflow: auto;
            background: var(--surface-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .pdf-viewer:hover {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgb(37 99 235 / 0.1);
        }

        .pdf-page {
            max-width: 100%;
            max-height: 100%;
            height: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .extracted-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
            padding: 10px;
        }

        .image-card {
            background: var(--surface-primary);
            border-radius: 16px;
            padding: 16px;
            box-shadow: var(--shadow-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            border: 2px solid transparent;
            overflow: hidden;
        }

        .image-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: transparent;
            transition: all 0.3s ease;
        }

        .image-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary-color);
        }

        .image-card:hover::before {
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
        }

        .image-card.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), rgba(59, 130, 246, 0.05));
            box-shadow: 0 0 0 4px rgb(37 99 235 / 0.1);
        }

        .image-card.selected::before {
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
        }

        .image-card.validated {
            border-color: var(--success-color);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(34, 197, 94, 0.05));
        }

        .image-card.validated::before {
            background: linear-gradient(90deg, var(--success-color), #22c55e);
        }

        .image-card.rejected {
            border-color: var(--error-color);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(248, 113, 113, 0.05));
            opacity: 0.8;
        }

        .image-card.rejected::before {
            background: linear-gradient(90deg, var(--error-color), #f87171);
        }

        .image-card.doubtful {
            border-color: var(--warning-color);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(251, 191, 36, 0.05));
        }

        .image-card.doubtful::before {
            background: linear-gradient(90deg, var(--warning-color), #fbbf24);
        }

        .image-card img {
            width: 100%;
            height: 120px;
            object-fit: contain;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .image-info {
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        .image-number {
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }

        .status-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid var(--surface-primary);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .status-badge.validated {
            background: var(--success-color);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .status-badge.rejected {
            background: var(--error-color);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }

        .status-badge.doubtful {
            background: var(--warning-color);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }

        .controls {
            background: var(--surface-primary);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(20px);
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-xl);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-validate {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
        }

        .btn-reject {
            background: linear-gradient(135deg, #f44336, #da190b);
            color: white;
        }

        .btn-doubt {
            background: linear-gradient(135deg, #ff9800, #fb8c00);
            color: white;
        }

        .btn-next {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-prev {
            background: linear-gradient(135deg, #9e9e9e, #757575);
            color: white;
        }

        .btn-export {
            background: linear-gradient(135deg, #00bcd4, #0097a7);
            color: white;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .progress-track {
            background: #e0e0e0;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            background: linear-gradient(135deg, #667eea, #764ba2);
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
        }

        .modal-image {
            max-width: 100%;
            height: auto;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            font-size: 30px;
            cursor: pointer;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #764ba2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .shortcuts {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 10px;
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .shortcuts h4 {
            margin-bottom: 5px;
            color: #764ba2;
        }

        .shortcut-item {
            display: flex;
            gap: 10px;
            margin: 3px 0;
        }

        .key {
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                üîç PDF Extraction Validator
            </h1>
            <div class="session-info">
                <span class="info-badge">üìÑ Page: <span id="currentPage">1</span> / <span id="totalPages">-</span></span>
                <span class="info-badge">üìÅ Session: <span id="sessionName">-</span></span>
                <span class="info-badge">üñºÔ∏è Images: <span id="imageCount">0</span></span>
                <span class="info-badge">‚ö° Mode: <span id="extractionMode">ULTRA</span></span>
            </div>
            <div style="margin-top: 15px;">
                <label for="sessionSelect" style="margin-right: 10px; font-weight: bold;">Choisir session :</label>
                <select id="sessionSelect" onchange="changeSession()" style="padding: 5px 10px; border-radius: 5px; border: 1px solid #ddd; background: white;">
                    <option value="">Chargement...</option>
                </select>
                <button onclick="refreshSessions()" style="margin-left: 10px; padding: 5px 10px; border-radius: 5px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer;">üîÑ</button>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-track">
                <div class="progress-fill" id="progressFill" style="width: 0%">
                    0%
                </div>
            </div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="statValidated">0</div>
                    <div class="stat-label">‚úÖ Valid√©es</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statRejected">0</div>
                    <div class="stat-label">‚ùå Rejet√©es</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statDoubtful">0</div>
                    <div class="stat-label">‚ö†Ô∏è Douteuses</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statPending">0</div>
                    <div class="stat-label">‚è≥ En attente</div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="control-buttons">
                <button class="btn btn-prev" onclick="previousPage()" id="btnPrev">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i> Page pr√©c√©dente
                </button>
                <button class="btn btn-validate" onclick="validateSelected()">
                    <i data-lucide="check" class="w-5 h-5"></i> Valider s√©lection (V)
                </button>
                <button class="btn btn-reject" onclick="rejectSelected()">
                    <i data-lucide="x" class="w-5 h-5"></i> Rejeter s√©lection (R)
                </button>
                <button class="btn btn-doubt" onclick="markDoubtful()">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i> Marquer douteux (D)
                </button>
                <button class="btn btn-next" onclick="nextPage()" id="btnNext">
                    Page suivante <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
                <button class="btn btn-export" onclick="exportResults()">
                    <i data-lucide="save" class="w-5 h-5"></i> Exporter r√©sultats
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- PDF Viewer Panel -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title"><i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i> PDF Original - Page <span id="pdfPageNum">1</span></span>
                    <button class="btn" onclick="zoomPDF()"><i data-lucide="zoom-in" class="w-5 h-5"></i> Zoom</button>
                </div>
                <div class="pdf-viewer" id="pdfViewer">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Chargement de la page PDF...</p>
                    </div>
                </div>
            </div>

            <!-- Extracted Images Panel -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title"><i data-lucide="images" class="w-5 h-5 text-blue-600"></i> Images Extraites</span>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <button class="btn" onclick="retryDoubtfulExtractions()"><i data-lucide="refresh-ccw" class="w-5 h-5"></i> Repasser Douteuses</button>
                        <button class="btn" onclick="selectAll()"><i data-lucide="check-square" class="w-5 h-5"></i> Tout s√©lectionner</button>
                    </div>
                </div>
                <div class="extracted-grid" id="extractedGrid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Chargement des images...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Keyboard Shortcuts -->
        <div class="shortcuts">
            <h4>‚å®Ô∏è Raccourcis</h4>
            <div class="shortcut-item">
                <span class="key">V</span> Valider
            </div>
            <div class="shortcut-item">
                <span class="key">R</span> Rejeter
            </div>
            <div class="shortcut-item">
                <span class="key">D</span> Douteux
            </div>
            <div class="shortcut-item">
                <span class="key">‚Üí</span> Page suivante
            </div>
            <div class="shortcut-item">
                <span class="key">‚Üê</span> Page pr√©c√©dente
            </div>
            <div class="shortcut-item">
                <span class="key">A</span> Tout s√©lectionner
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal" id="imageModal" onclick="closeModal()">
        <button class="close-modal" onclick="closeModal()">√ó</button>
        <div class="modal-content" onclick="event.stopPropagation()">
            <img class="modal-image" id="modalImage" src="" alt="">
            <div style="margin-top:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <button class="btn" onclick="redetectFromModal(0)"><i data-lucide='scan' class='w-5 h-5'></i> Red√©tection</button>
                <button class="btn" onclick="redetectFromModal(10)"><i data-lucide='zoom-in' class='w-5 h-5'></i> + Largeur</button>
                <button class="btn" onclick="redetectFromModal(-10)"><i data-lucide='zoom-out' class='w-5 h-5'></i> - Largeur</button>
            </div>
        </div>
    </div>

    <script>
        // √âtat de l'application
        let currentPage = 1;
        let totalPages = 10;
        let selectedImages = new Set();
        let imageStates = {}; // {imageId: 'validated' | 'rejected' | 'doubtful' | 'pending'}
        let sessionData = null;
        let currentImages = [];

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            loadAvailableSessions();
            if (window.lucide) { lucide.createIcons(); }
            setupKeyboardShortcuts();
            updateProgress();
        });

        // Charger les sessions disponibles
        async function loadAvailableSessions() {
            try {
                const response = await fetch('/api/sessions');
                if (response.ok) {
                    const data = await response.json();
                    const sessions = data.sessions;
                    
                    const select = document.getElementById('sessionSelect');
                    select.innerHTML = '';
                    
                    if (sessions.length === 0) {
                        select.innerHTML = '<option value="">Aucune session trouv√©e</option>';
                        return;
                    }
                    
                    // Ajouter les sessions
                    sessions.forEach(session => {
                        const option = document.createElement('option');
                        option.value = session.name;
                        option.textContent = `${session.pdf_name} (${session.total_pages}p, ${session.total_images}img)`;
                        select.appendChild(option);
                    });
                    
                    // S√©lectionner automatiquement la premi√®re session
                    if (sessions.length > 0) {
                        select.value = sessions[0].name;
                        await changeSession();
                    }
                } else {
                    console.error('Erreur chargement sessions');
                    document.getElementById('sessionSelect').innerHTML = '<option value="">Erreur serveur</option>';
                }
            } catch (error) {
                console.error('Erreur connexion serveur:', error);
                document.getElementById('sessionSelect').innerHTML = '<option value="">Serveur non disponible</option>';
                
                // Fallback sur mode d√©mo
                loadSession();
            }
        }

        // Changer de session
        async function changeSession() {
            const select = document.getElementById('sessionSelect');
            const sessionName = select.value;
            
            if (!sessionName) return;
            
            try {
                // D√©finir la session active sur le serveur
                const response = await fetch(`/api/session/${sessionName}`);
                if (response.ok) {
                    // Charger les donn√©es de la nouvelle session
                    await loadSession();
                } else {
                    alert('Erreur lors du changement de session');
                }
            } catch (error) {
                console.error('Erreur changement session:', error);
                alert('Impossible de changer de session');
            }
        }

        // Rafra√Æchir la liste des sessions
        async function refreshSessions() {
            await loadAvailableSessions();
        }

        // Charger la session
        async function loadSession() {
            try {
                // Charger les vraies donn√©es depuis le serveur
                const response = await fetch('/api/get-session-data');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                sessionData = await response.json();

                document.getElementById('sessionName').textContent = sessionData.sessionName;
                document.getElementById('totalPages').textContent = sessionData.totalPages;
                document.getElementById('extractionMode').textContent = sessionData.mode;
                
                totalPages = sessionData.totalPages;
                
                loadPage(1);
            } catch (error) {
                console.error('Erreur chargement session:', error);
                
                // Fallback sur des donn√©es de d√©mo si le serveur n'est pas disponible
                sessionData = {
                    sessionName: "DEMO_SESSION",
                    totalPages: 5,
                    mode: "DEMO",
                    pdfPath: "/demo/path"
                };

                document.getElementById('sessionName').textContent = sessionData.sessionName + " (DEMO)";
                document.getElementById('totalPages').textContent = sessionData.totalPages;
                document.getElementById('extractionMode').textContent = sessionData.mode;
                
                totalPages = sessionData.totalPages;
                loadPage(1);
            }
        }

        // Charger une page
        async function loadPage(pageNum) {
            currentPage = pageNum;
            document.getElementById('currentPage').textContent = pageNum;
            document.getElementById('pdfPageNum').textContent = pageNum;
            
            // R√©initialiser la s√©lection
            selectedImages.clear();
            
            // Charger l'image PDF
            loadPDFPage(pageNum);
            
            // Charger les images extraites
            loadExtractedImages(pageNum);
            
            // Mettre √† jour les boutons
            document.getElementById('btnPrev').disabled = pageNum === 1;
            document.getElementById('btnNext').disabled = pageNum === totalPages;
            
            updateProgress();
        }

        // Charger la page PDF
        async function loadPDFPage(pageNum) {
            const pdfViewer = document.getElementById('pdfViewer');
            
            // Afficher un loader
            pdfViewer.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Chargement de la page PDF ${pageNum}...</p>
                </div>
            `;
            
            try {
                // Essayer de charger la vraie page PDF
                const response = await fetch(`/api/get-pdf-page/${pageNum}`);
                
                if (response.ok && response.headers.get('content-type')?.includes('image')) {
                    // C'est une image - l'afficher directement
                    const imageBlob = await response.blob();
                    const imageUrl = URL.createObjectURL(imageBlob);
                    
                    pdfViewer.innerHTML = `
                        <div style="text-align: center; padding: 10px;">
                            <img src="${imageUrl}" 
                                 class="pdf-page" 
                                 alt="PDF Page ${pageNum}"
                                 style="max-width: 100%; height: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        </div>
                    `;
                } else {
                    // Erreur ou pas d'image - afficher le placeholder avec infos
                    const errorData = await response.json();
                    
            pdfViewer.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='600' viewBox='0 0 400 600'%3E%3Crect width='400' height='600' fill='%23f0f0f0'/%3E%3Ctext x='200' y='280' font-family='Arial' font-size='24' fill='%23666' text-anchor='middle'%3EPDF Page ${pageNum}%3C/text%3E%3Ctext x='200' y='320' font-family='Arial' font-size='14' fill='%23999' text-anchor='middle'%3E${errorData.message || 'PDF non disponible'}%3C/text%3E%3C/svg%3E" 
                         class="pdf-page" alt="PDF Page ${pageNum}">
                    <p style="margin-top: 10px; color: #666;">
                                ${errorData.error || 'PDF original non trouv√©'}
                    </p>
                            ${errorData.pdf_path ? `<p style="font-size: 12px; color: #999;">Chemin: ${errorData.pdf_path}</p>` : ''}
                </div>
            `;
                }
                
            } catch (error) {
                console.error('Erreur chargement PDF:', error);
                
                // Fallback complet
                pdfViewer.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='600' viewBox='0 0 400 600'%3E%3Crect width='400' height='600' fill='%23f0f0f0'/%3E%3Ctext x='200' y='280' font-family='Arial' font-size='24' fill='%23666' text-anchor='middle'%3EPDF Page ${pageNum}%3C/text%3E%3Ctext x='200' y='320' font-family='Arial' font-size='14' fill='%23999' text-anchor='middle'%3EServeur non disponible%3C/text%3E%3C/svg%3E" 
                             class="pdf-page" alt="PDF Page ${pageNum}">
                        <p style="margin-top: 10px; color: #666;">
                            ‚ö†Ô∏è Impossible de charger le PDF original
                        </p>
                        <p style="font-size: 12px; color: #999;">
                            V√©rifiez que le serveur est d√©marr√© et que le PDF source existe
                        </p>
                    </div>
                `;
            }
        }

        // Charger les images extraites
        async function loadExtractedImages(pageNum) {
            const grid = document.getElementById('extractedGrid');
            
            try {
                // Charger les vraies images depuis le serveur
                const response = await fetch(`/api/get-page-images/${pageNum}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                currentImages = [];
                
                let html = '';
                data.images.forEach((image, index) => {
                    const imageId = `page${pageNum}_${image.filename}`;
                    currentImages.push(imageId);
                    
                    // Initialiser l'√©tat selon la classification ULTRA
                    if (!imageStates[imageId]) {
                        imageStates[imageId] = image.is_doubtful ? 'doubtful' : 'pending';
                    }
                    
                    const state = imageStates[imageId];
                    const stateClass = state !== 'pending' ? state : '';
                    
                    html += `
                        <div class="image-card ${stateClass} ${image.is_doubtful ? 'doubtful' : ''}" 
                             id="${imageId}" 
                             onclick="toggleSelection('${imageId}')"
                             ondblclick="showFullImage('${imageId}')">
                            <div class="status-badge ${state !== 'pending' ? state : ''}"></div>
                            <img src="/api/get-image/${image.path}" alt="${image.filename}">
                            <div class="image-info">
                                <div class="image-number">${image.artwork_number || image.filename}</div>
                                <div>${image.is_doubtful ? '‚ö†Ô∏è Douteuse' : 'üì∑ Normale'}</div>
                                ${image.artwork_number ? `<div>üé® ≈íuvre ${image.artwork_number}</div>` : ''}
                                ${image.was_rotated ? `<div>üîÑ Rotation corrig√©e</div>` : ''}
                                <div>üìè ${image.dimensions}</div>
                                <div>üíæ ${image.size_kb}KB</div>
                                <div>üîç ${image.detection_method}</div>
                            </div>
                        </div>
                    `;
                });
                
                grid.innerHTML = html;
                if (window.lucide) { lucide.createIcons(); }
                document.getElementById('imageCount').textContent = data.images.length;
                
            } catch (error) {
                console.error('Erreur chargement images:', error);
                
                // Fallback sur des donn√©es de d√©mo
                const imageCount = 6 + Math.floor(Math.random() * 4);
            currentImages = [];
            
            let html = '';
            for (let i = 1; i <= imageCount; i++) {
                    const imageId = `page${pageNum}_demo${i}`;
                    const isDoubtful = Math.random() < 0.3; // 30% douteuses en d√©mo
                
                // Initialiser l'√©tat si n√©cessaire
                if (!imageStates[imageId]) {
                    imageStates[imageId] = isDoubtful ? 'doubtful' : 'pending';
                }
                
                currentImages.push(imageId);
                
                const state = imageStates[imageId];
                const stateClass = state !== 'pending' ? state : '';
                
                html += `
                    <div class="image-card ${stateClass}" 
                         id="${imageId}" 
                         onclick="toggleSelection('${imageId}')"
                         ondblclick="showFullImage('${imageId}')">
                            <div class="status-badge ${state !== 'pending' ? state : ''}"></div>
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='120' viewBox='0 0 150 120'%3E%3Crect width='150' height='120' fill='%23e0e0e0'/%3E%3Ctext x='75' y='60' font-family='Arial' font-size='12' fill='%23666' text-anchor='middle'%3EDEMO ${i}%3C/text%3E%3C/svg%3E" 
                                 alt="Demo Image ${i}">
                            <div class="image-info">
                                <div class="image-number">Demo ${i}</div>
                                <div>${isDoubtful ? '‚ö†Ô∏è Douteuse' : 'üì∑ Normale'}</div>
                                <div>üîß Mode d√©mo</div>
                            </div>
                        </div>
                    `;
                }
                
                grid.innerHTML = html;
                if (window.lucide) { lucide.createIcons(); }
                document.getElementById('imageCount').textContent = imageCount;
            }
        }

        // Repasser automatiquement sur les images douteuses (post-traitement serveur)
        async function retryDoubtfulExtractions() {
            try {
                const response = await fetch('/api/retry-doubtful', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ page: currentPage })
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    alert(`Post-traitement appliqu√© sur ${data.processed} image(s) douteuse(s).`);
                    // Recharger la page courante pour afficher les nouvelles versions
                    await loadExtractedImages(currentPage);
                } else {
                    alert(`Erreur post-traitement: ${data.error || 'inconnue'}`);
                }
            } catch (e) {
                console.error(e);
                alert('Erreur lors du post-traitement des images douteuses');
            }
        }

        // Basculer la s√©lection d'une image
        function toggleSelection(imageId) {
            const element = document.getElementById(imageId);
            
            if (selectedImages.has(imageId)) {
                selectedImages.delete(imageId);
                element.classList.remove('selected');
            } else {
                selectedImages.add(imageId);
                element.classList.add('selected');
            }
        }

        // Afficher l'image en plein √©cran
        function showFullImage(imageId) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            // Si on a d√©j√† l'√©l√©ment dans la grille, on peut retrouver l'img r√©elle si pr√©sente
            const el = document.getElementById(imageId);
            const imgEl = el ? el.querySelector('img') : null;
            if (imgEl && imgEl.src) {
                modalImage.src = imgEl.src;
            } else {
                modalImage.src = '';
            }
            // Stocker le contexte courant pour actions avanc√©es
            modal.dataset.currentImageId = imageId;
            modal.classList.add('active');
        }

        // Fermer la modale
        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
        }

        // Red√©tection √† partir du modal: on appelle l'API avec la bbox si dispo
        async function redetectFromModal(padDelta = 0) {
            const modal = document.getElementById('imageModal');
            const imageId = modal.dataset.currentImageId;
            if (!imageId) return;

            // Retrouver les infos de bbox si disponibles dans les donn√©es charg√©es
            // On poss√®de seulement le filename dans l'ID (pageX_filename). On recharge la page pour acc√©der aux d√©tails.
            try {
                const response = await fetch(`/api/get-page-images/${currentPage}`);
                const data = await response.json();
                const filename = imageId.split('_').slice(1).join('_');
                const img = data.images.find(i => `page${currentPage}_${i.filename}` === imageId);
                if (!img) {
                    alert("D√©tails introuvables pour cette image");
                    return;
                }
                // On attend que le serveur fournisse bbox dans le futur; fallback: rien
                const bbox = img.bbox || { x: 0, y: 0, w: 0, h: 0 };
                if (!bbox.w || !bbox.h) {
                    alert("Bordures (bbox) non disponibles dans les m√©tadonn√©es.");
                    return;
                }

                const pad = Math.max(0, 20 + padDelta);
                const res = await fetch('/api/redetect-crop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ page: currentPage, bbox, pad, filename: filename })
                });
                const out = await res.json();
                if (res.ok && out.success) {
                    // Afficher le nouveau recadrage dans la modale
                    const modalImg = document.getElementById('modalImage');
                    modalImg.src = `/api/get-image/${out.path}`;
                    // Et rafra√Æchir la grille pour que l'utilisateur voie les nouvelles images si besoin
                    await loadExtractedImages(currentPage);
                } else {
                    alert(out.error || 'Erreur red√©tection');
                }
            } catch (e) {
                console.error(e);
                alert('Erreur red√©tection');
            }
        }

        // Valider les images s√©lectionn√©es
        function validateSelected() {
            selectedImages.forEach(imageId => {
                imageStates[imageId] = 'validated';
                const element = document.getElementById(imageId);
                element.className = 'image-card validated';
                element.querySelector('.status-badge').className = 'status-badge validated';
            });
            selectedImages.clear();
            updateProgress();
        }

        // Rejeter les images s√©lectionn√©es
        function rejectSelected() {
            selectedImages.forEach(imageId => {
                imageStates[imageId] = 'rejected';
                const element = document.getElementById(imageId);
                element.className = 'image-card rejected';
                element.querySelector('.status-badge').className = 'status-badge rejected';
            });
            selectedImages.clear();
            updateProgress();
        }

        // Marquer comme douteuses
        function markDoubtful() {
            selectedImages.forEach(imageId => {
                imageStates[imageId] = 'doubtful';
                const element = document.getElementById(imageId);
                element.className = 'image-card doubtful';
                element.querySelector('.status-badge').className = 'status-badge doubtful';
            });
            selectedImages.clear();
            updateProgress();
        }

        // S√©lectionner toutes les images
        function selectAll() {
            currentImages.forEach(imageId => {
                selectedImages.add(imageId);
                document.getElementById(imageId).classList.add('selected');
            });
        }

        // Page pr√©c√©dente
        function previousPage() {
            if (currentPage > 1) {
                loadPage(currentPage - 1);
            }
        }

        // Page suivante
        function nextPage() {
            if (currentPage < totalPages) {
                loadPage(currentPage + 1);
            }
        }

        // Zoom PDF
        function zoomPDF() {
            const pdfViewer = document.getElementById('pdfViewer');
            const img = pdfViewer.querySelector('.pdf-page');
            if (img) {
                if (img.style.transform === 'scale(1.5)') {
                    img.style.transform = 'scale(1)';
                } else {
                    img.style.transform = 'scale(1.5)';
                }
            }
        }

        // Mettre √† jour la barre de progression
        function updateProgress() {
            const allImages = Object.keys(imageStates);
            const validated = allImages.filter(id => imageStates[id] === 'validated').length;
            const rejected = allImages.filter(id => imageStates[id] === 'rejected').length;
            const doubtful = allImages.filter(id => imageStates[id] === 'doubtful').length;
            const pending = allImages.filter(id => imageStates[id] === 'pending').length;
            const total = allImages.length;

            // Mettre √† jour les statistiques
            document.getElementById('statValidated').textContent = validated;
            document.getElementById('statRejected').textContent = rejected;
            document.getElementById('statDoubtful').textContent = doubtful;
            document.getElementById('statPending').textContent = pending;

            // Mettre √† jour la barre de progression
            const processed = validated + rejected + doubtful;
            const percentage = total > 0 ? Math.round((processed / total) * 100) : 0;
            
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = `${percentage}%`;
            progressFill.textContent = `${percentage}%`;
        }

        // Exporter les r√©sultats
        async function exportResults() {
            const results = {
                sessionName: sessionData.sessionName,
                timestamp: new Date().toISOString(),
                totalPages: totalPages,
                currentPage: currentPage,
                imageStates: imageStates,
                summary: {
                    validated: Object.values(imageStates).filter(s => s === 'validated').length,
                    rejected: Object.values(imageStates).filter(s => s === 'rejected').length,
                    doubtful: Object.values(imageStates).filter(s => s === 'doubtful').length,
                    pending: Object.values(imageStates).filter(s => s === 'pending').length
                }
            };

            try {
                // Essayer de sauvegarder sur le serveur
                const response = await fetch('/api/save-validation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(results)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úÖ Validation sauvegard√©e sur le serveur!\nüìÅ ${result.file}`);
                    
                    // Proposer aussi l'export des images valid√©es
                    if (results.summary.validated > 0) {
                        if (confirm(`Voulez-vous aussi exporter les ${results.summary.validated} images valid√©es dans un dossier s√©par√© ?`)) {
                            await exportValidatedImages();
                        }
                    }
                } else {
                    throw new Error('Erreur serveur');
                }
            } catch (error) {
                console.error('Erreur sauvegarde serveur:', error);
                
                // Fallback sur l'export local
                const blob = new Blob([JSON.stringify(results, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `validation_results_${sessionData.sessionName}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert('‚ö†Ô∏è Serveur non disponible - R√©sultats export√©s localement');
            }
        }

        // Exporter uniquement les images valid√©es
        async function exportValidatedImages() {
            try {
                const results = {
                    sessionName: sessionData.sessionName,
                    imageStates: imageStates
                };

                const response = await fetch('/api/export-validated-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(results)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úÖ ${result.count} images valid√©es export√©es!\nüìÅ ${result.export_dir}`);
                } else {
                    throw new Error('Erreur export images');
                }
            } catch (error) {
                console.error('Erreur export images:', error);
                alert('‚ùå Erreur lors de l\'export des images valid√©es');
            }
        }

        // Configuration des raccourcis clavier
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ignorer si on tape dans un input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                switch (e.key.toLowerCase()) {
                    case 'v':
                        e.preventDefault();
                        validateSelected();
                        break;
                    case 'r':
                        e.preventDefault();
                        rejectSelected();
                        break;
                    case 'd':
                        e.preventDefault();
                        markDoubtful();
                        break;
                    case 'arrowright':
                        e.preventDefault();
                        nextPage();
                        break;
                    case 'arrowleft':
                        e.preventDefault();
                        previousPage();
                        break;
                    case 'a':
                        e.preventDefault();
                        selectAll();
                        break;
                    case 'escape':
                        e.preventDefault();
                        closeModal();
                        selectedImages.clear();
                        document.querySelectorAll('.image-card.selected').forEach(el => {
                            el.classList.remove('selected');
                        });
                        break;
                }
            });
        }

        // Fonction pour int√©grer avec le backend Python (extracteur ULTRA)
        async function loadRealSession() {
            try {
                // En production, remplacer par votre endpoint
                const response = await fetch('/api/get-session-data');
                const data = await response.json();
                
                sessionData = data;
                totalPages = data.totalPages;
                
                // Charger les vraies donn√©es
                document.getElementById('sessionName').textContent = data.sessionName;
                document.getElementById('totalPages').textContent = data.totalPages;
                document.getElementById('extractionMode').textContent = data.mode;
                
                loadPage(1);
            } catch (error) {
                console.error('Erreur chargement session r√©elle:', error);
                // Fallback sur les donn√©es de d√©mo
                loadSession();
            }
        }

        // Fonction pour charger les vraies images extraites du dossier ULTRA
        async function loadRealExtractedImages(pageNum) {
            try {
                const response = await fetch(`/api/get-page-images/${pageNum}`);
                const data = await response.json();
                
                const grid = document.getElementById('extractedGrid');
                let html = '';
                
                currentImages = [];
                
                data.images.forEach((image, index) => {
                    const imageId = `page${pageNum}_${image.filename}`;
                    currentImages.push(imageId);
                    
                    // Initialiser l'√©tat selon la classification ULTRA
                    if (!imageStates[imageId]) {
                        imageStates[imageId] = image.is_doubtful ? 'doubtful' : 'pending';
                    }
                    
                    const state = imageStates[imageId];
                    const stateClass = state !== 'pending' ? state : '';
                    
                    // D√©terminer le dossier (normal ou DOUTEUX)
                    const folder = image.is_doubtful ? 'DOUTEUX' : '';
                    const imagePath = folder ? `${folder}/${image.filename}` : image.filename;
                    
                    html += `
                        <div class="image-card ${stateClass} ${image.is_doubtful ? 'doubtful' : ''}" 
                             id="${imageId}" 
                             onclick="toggleSelection('${imageId}')"
                             ondblclick="showFullImage('${imageId}')">
                            <div class="status-badge ${state !== 'pending' ? state : ''}"></div>
                            <img src="/api/get-image/page_${pageNum}/${imagePath}" alt="${image.filename}">
                            <div class="image-info">
                                <div class="image-number">${image.artwork_number || image.filename}</div>
                                <div>${image.is_doubtful ? '‚ö†Ô∏è Douteuse' : 'üì∑ Normale'}</div>
                                ${image.artwork_number ? `<div>üé® ≈íuvre ${image.artwork_number}</div>` : ''}
                                ${image.was_rotated ? `<div>üîÑ Rotation corrig√©e</div>` : ''}
                                <div>üìè ${image.dimensions}</div>
                                <div>üíæ ${image.size_kb}KB</div>
                            </div>
                        </div>
                    `;
                });
                
                grid.innerHTML = html;
                document.getElementById('imageCount').textContent = data.images.length;
                
            } catch (error) {
                console.error('Erreur chargement images r√©elles:', error);
                // Fallback sur les donn√©es de d√©mo
                loadExtractedImages(pageNum);
            }
        }

        // Sauvegarder les r√©sultats de validation
        async function saveValidationResults() {
            try {
                const results = {
                    sessionName: sessionData.sessionName,
                    timestamp: new Date().toISOString(),
                    totalPages: totalPages,
                    imageStates: imageStates
                };

                const response = await fetch('/api/save-validation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(results)
                });

                if (response.ok) {
                    alert('Validation sauvegard√©e avec succ√®s !');
                } else {
                    throw new Error('Erreur sauvegarde');
                }
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                // Fallback sur l'export local
                exportResults();
            }
        }
    </script>
</body>
</html>